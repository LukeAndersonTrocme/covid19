---
title: "Covid Log Ratio"
author:
- name: Luke Anderson-Trocm√©,
  affiliation:
  - &cruk Department of Human Genetics, McGill University,  Montreal, Canada
date: '`r format(Sys.Date(), "%Y-%B-%d")`'
output:
  html_notebook:
    df_print: paged
    code_folding: show
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: false
---
# Load Libraries and set paths
```{r setup}
pacman::p_load(ggplot2) # plotting functions
pacman::p_load(cowplot) # combine plots
pacman::p_load(ggrepel) # repel label text
pacman::p_load(dplyr) # data wrangling
pacman::p_load(jsonlite)
pacman::p_load(data.table)
pacman::p_load(tidyverse)
pacman::p_load(tsibble) # for difference function
pacman::p_load(lubridate)
pacman::p_load(colorspace)
pacman::p_load(ggthemes)
pacman::p_load(locfit)


#Set Path
covidPath <- '~/Documents/covid19/data/world/'
covidFigPath <- '~/Documents/covid19/figures/'

today <- format(Sys.Date(), "%Y-%B-%d")
```
# Load Data
```{r, warning = F, message = F}
##################################################
# covdata
# https://github.com/kjhealy/covdata
#remotes::install_github("kjhealy/covdata")
##################################################

library("drat")
drat::addRepo("kjhealy")
install.packages("covdata")
library(tidyverse)
library(covdata)
library(ggrepel)
library(paletteer)
library(prismatic)

covnat

##Stringency index
https://ocgptweb.azurewebsites.net/CSVDownload
```

```{r}
us_states <- read.csv(paste0(covidPath, "states.csv"))
us_regions <- read.csv(paste0(covidPath, "US/state_regions.csv"))
us_lockdown <- read.csv(paste0(covidPath,"US/state_lockdown.csv")) %>%
  mutate(lockdown_date = as.Date(lockdown_date, format = "%B %d, %Y"))

#Google mobility trends
#mobility_data_url <- "https://raw.githubusercontent.com/nacnudus/google-location-coronavirus/master/2020-04-05-country.tsv"
#download.file(mobility_data_url, destfile = paste0(covidPath, "2020-04-05-country.tsv"), quiet = T)

## Countries to highlight
focus_states <- c("NY","NJ","MI","MA","PA")

## Which n states are leading the count of positive cases or deaths?
top <-10
top_n_states <- function(data, n = top, measure = c("positive", "death")) {
  meas <- match.arg(measure)
  data %>%
  group_by(region) %>%
  filter(measure == meas, date == max(date)) %>%
  drop_na() %>%
  ungroup() %>%
  top_n(n, wt = count) %>%
  pull(region)
}

state_cols <- c("gray70", 
                prismatic::clr_darken(paletteer_d("ggsci::category20_d3"), 0.2))

## Colors
cgroup_cols <- c(clr_darken(paletteer_d("ggsci::category20_d3"), 0.2)[1:top], "gray70")

states <-
  fread(paste0(covidPath, "2020-04-05-country.tsv"), sep = "\t", header = T) %>%
  filter(country_name == "United States", 
         type == "region",
         category == "Residential") %>%
  dplyr::select(-c(url, page, row,col, group)) %>%
  mutate(date = as.Date(date)) %>%
  inner_join( . ,
         us_regions,
         by = "region_name") %>%
  inner_join(. ,
             covus %>% filter(measure == "positive"),
             by = c("state","date")) %>%
  inner_join( . ,
              us_lockdown,
              by = "region_name") %>%
  filter(count > 49) %>%
  arrange(date) %>%
  group_by(state) %>%
  mutate(cases_logratio = tsibble::difference(log(count)),
         doubling_time = log(2) / cases_logratio,
         from_shutdown = as.numeric(difftime(date, lockdown_date, units = "days")),
         #core = case_when(region %nin% top_n_states(covus) ~ "",
        #                  TRUE ~ region),
         end_label = ifelse(date == max(date), state, NA),
         #end_label = case_when(region %in% core ~ end_label,
        #                       TRUE ~ NA_character_),
         #cgroup = case_when(region %in% core ~ region,
        #                    TRUE ~ "ZZOTHER"),
         days_elapsed = as.numeric(date - min(date))) %>%
  filter(from_shutdown > -15) 
  #dplyr::select(state, date, from_shutdown, days_elapsed, cases_logratio,doubling_time, count, deaths, trend, end_label)
  
#states$state <- reorder(states$state, states$count)
states$state <- factor(states$state, levels = unique(states[order(states$region),]$state), ordered = TRUE)


state_tests <-
  covus %>%
  filter(measure %in% c('positive','negative')) %>%
  group_by(state, date) %>%
  dplyr::summarise(total_tests = sum(count, na.rm = T)) %>%
  inner_join( . ,
              states,
              by = c("state","date")) %>%
  arrange(date) %>%
  group_by(state) %>%
  mutate(tests_logratio = tsibble::difference(log(total_tests)),
         doubling_time = log(2) / tests_logratio)


states %>% filter(!is.na(end_label))
```

```{r}
cu<-
  ggplot(states %>%
           arrange(desc(date)),
         aes(x = days_elapsed, 
             y = count, 
             color = state, 
             label = end_label, 
             group = state)) + 
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") +
  #geom_vline(data = prov %>% filter(from_shutdown == 0),
  #           aes(xintercept = days_elapsed),
  #           size = 0.5, linetype =2,
  #           color = "black") +
  geom_line(size = 1.5) + 
  geom_point(size = 1) + 
  guides(color = FALSE) + 
  #scale_color_gradient(low = "tomato3", high = "yellow2") +
  scale_color_discrete_sequential() +
  scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                     breaks = 2^seq(-2, 15, 1) * 100,
                     trans = "log2") + 
  ylab("Cumulative Number of Cases (log2 scale)")+
  theme_minimal() +
  theme(axis.line.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA")) +
  facet_grid(.~region, scales = "free_x", space = "free_x")

lr <-
ggplot(states %>%
           arrange(desc(date)),
         aes(x = days_elapsed, 
             y = doubling_time, 
             color = state, 
             label = end_label, 
             group = state)) + 
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") +
  #geom_vline(data = prov %>% filter(from_shutdown == 0),
  #           aes(xintercept = days_elapsed),
  #           size = 0.5, linetype =2,
  #           color = "black") +
  geom_point() +
  geom_smooth(method = "locfit",  size = 0.5, color = "black") + #se = FALSE,
  #geom_line(size = 0.5) +
  guides(color = FALSE) + 
  #scale_color_gradient(low = "tomato3", high = "yellow2") +
  scale_color_discrete_sequential() +
  ylab("Doubling Time")+
  theme_minimal() +
  theme(axis.line.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA")) +
  facet_grid(.~region, scales = "free_x", space = "free_x")

mobility <-
ggplot(states %>%
           arrange(desc(date)),
         aes(x = days_elapsed, 
             y = trend,
             color = state,
             group = state,
             label = end_label)) +
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") +
  #geom_vline(data = prov %>% filter(from_shutdown == 0),
  #           aes(xintercept = days_elapsed),
  #           size = 0.5, linetype =2,
  #           color = "black") +
  geom_point() +
  geom_smooth(method = "locfit",  size = 0.5, color = "black") +
  #scale_color_gradient(low = "tomato3", high = "yellow2", breaks = c(2,7,14,21)) +
  scale_color_discrete_sequential() +
  labs(x = "Days Since 10th Confirmed Case", y = "Residential activity trends") +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.border = element_rect(color = "black", fill = "NA")) +
  facet_grid(.~region, scales = "free_x", space = "free_x")

plot_grid(cu,lr,mobility,ncol=1, rel_heights = c(1,1,1.2), align = "v", axis = "b")

ggsave(paste0(covidFigPath, "log_ratio_us_regions.jpg"), height = 8, width = 11)
```

```{r}
p1 <-
  ggplot(states,
         aes(x = from_shutdown, 
             y = count, 
             color = region,#cgroup, 
             label = end_label, 
             group = region)) + 
  geom_vline(xintercept = 0) +
  geom_line(size = 1.5) + 
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") + 
  #scale_color_manual(values = cgroup_cols) +
  guides(color = FALSE) + 
  scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                     breaks = 10^seq(1, 10, 1),
                     trans = "log2") + 
  xlab("Days Since Social Distancing Policy") +
  ylab("CODID-19 Cases (log2 scale)")+
  theme_minimal() + 
  facet_grid()


p2 <-
  ggplot(states,
         aes(x = from_shutdown, 
             y = doubling_time, 
             color = region, 
             label = end_label, 
             group = region)) + 
  geom_vline(xintercept = 0) +
  #geom_point(size = 0.5) + 
  geom_smooth(method = "locfit", se = F) +
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") + 
  #scale_color_manual(values = cgroup_cols) +
  guides(color = FALSE) + 
  xlab("Days Since Social Distancing Policy") +
  ylab("Doubling Time")+
  theme_minimal() +
  ylim(c(0,14))

p2.5 <-
  ggplot(states,
         aes(x = from_shutdown, 
             y = cases_logratio, 
             color = region,
             label = end_label, 
             group = region)) + 
  geom_vline(xintercept = 0) +
  #geom_point(size = 0.5) + 
  geom_smooth(method = "locfit", se = F) +
  #geom_line() +
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") + 
  #scale_color_manual(values = cgroup_cols) +
  guides(color = FALSE) + 
  xlab("Days Since Social Distancing Policy") +
  ylab("Log Ratio")+
  theme_minimal() +
  ylim(c(0,0.6))

p3 <-
  ggplot(states,
         aes(x = from_shutdown, 
             y = trend, 
             color = region, 
             label = end_label, 
             group = state)) + 
  geom_vline(xintercept = 0) +
  #geom_point(size = 0.5) + 
  geom_smooth(method = "locfit", se = F) +
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") + 
  #scale_color_manual(values = cgroup_cols) +
  guides(color = FALSE) + 
  scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                     breaks = 10^seq(1, 10, 1),
                     trans = "log2") + 
  xlab("Days Since Social Distancing Policy") +
  ylab("Residential mobility trends")+
  theme_minimal()
pp <-
plot_grid(p1,p2,p2.5,p3,ncol=1, align = "v", axis = "b")
pp
```

```{r}
## Countries to highlight
focus_cn <- c("USA","KOR", "ITA", "DNK", "SGP", "SWE", "GBR", "CAN")
case_countries <- c("United States", "Italy", "United Kingdom", "Canada", "Sweden", "Denmark", "South Korea", "Singapore")
lockdown <- read.csv(paste0(covidPath,"lockdown.csv"), colClasses = c("character","Date","Date"))

case_study <-
  covnat %>%
  filter(iso3 %in% focus_cn,
         cu_cases > 50) %>%
  mutate(country_name = recode(cname, `Korea, Republic of` = "South Korea")) %>%
  arrange(date)

mobility_data <- 
  fread(paste0(covidPath, "2020-04-05-country.tsv"), sep = "\t", header = T) %>%
  dplyr::select(-c(url, page, row,col, group)) %>%
  filter(type == "country",
         category == "Residential")  %>% 
  mutate(date = as.Date(date)) %>%
  filter(country_name %in% case_countries) %>%
  right_join( . ,
              case_study,
              by = c("country_name","date")) %>% 
  inner_join( . ,
              lockdown,
              by = "country_name") %>%
  arrange(date) %>%
  group_by(country_name)%>% 
  mutate(cases_logratio = tsibble::difference(log(cu_cases)),
         doubling_time = log(2) / cases_logratio,
         from_shutdown = as.numeric(difftime(date, shutdown_date, units = "days")),
         end_label = ifelse(from_shutdown == max(from_shutdown), country_name, NA),
         days_elapsed = as.numeric(date - min(date)),) %>%
  filter(from_shutdown > -31, #keep only a range of days from shutown
         from_shutdown < 41) %>%
  dplyr::select(country_name, date, from_shutdown, days_elapsed, cases_logratio,doubling_time, cu_cases, cu_deaths, trend,intersects, first_case, end_label)
  
mobility_data

mobility_data$country_name <- reorder(mobility_data$country_name, -mobility_data$cu_cases)#factor(mobility_data$country_name, levels = case_countries)

doubling_moments <-
  mobility_data %>%
  group_by(country_name) %>%
  mutate(n = n(), #get number of days
         intersects = sapply(seq(1,max(n),1), function(kk) #get moments of doubling
           optimize(function(t0) abs(approxfun(from_shutdown, log2(cu_cases))(t0) - kk),
                    interval = range(from_shutdown))$minimum),
         doubling_day = T,
         from_shutdown = round(intersects)) %>%
  dplyr::select(country_name, from_shutdown,doubling_day) %>%
  unique() %>%
  right_join(.,
             mobility_data,
             by = c("country_name","from_shutdown"))

usa_tests <-
  covus %>%
  filter(measure %in% c('positive','negative')) %>%
  group_by(date) %>%
  dplyr::summarise(total_tests_USA = sum(count, na.rm = T)) %>%
  inner_join( . ,
              case_study %>% filter(iso3 == "USA"),
              by = "date")
```


```{r}
cu<-
  ggplot(mobility_data %>%
           arrange(desc(date)),
         aes(x = from_shutdown, 
             y = cu_cases, 
             color = doubling_time, 
             label = end_label, 
             group = country_name)) + 
  geom_segment(data = doubling_moments %>% filter(doubling_day == T),
               mapping = aes(x = from_shutdown,
                             xend = from_shutdown,
                             y = cu_cases,
                             yend = 0),
               color = "black",
               alpha = 0.5,
               size = 0.5) +
  geom_point(data = mobility_data %>% filter(cu_deaths > 100),
             aes(y = cu_deaths),
             color = "black",
             size = 0.5) +
  geom_text(data = doubling_moments %>% filter(doubling_day == T),
            mapping = aes(x = from_shutdown,
                          y = cu_cases,
                          label = round(doubling_time)),
            color = "black",
            size = 2,
            nudge_y = log2(2)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_line(size = 1.5) + 
  geom_point(size = 1) + 
  guides(color = FALSE) + 
  scale_color_gradient(low = "tomato3", high = "yellow2", limits = c(0,27)) +
  scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                     breaks = 2^seq(0, 15, 1) * 100,
                     trans = "log2") + 
  ylab("Cumulative Number of Reported Cases (log2 scale)")+
  theme_minimal() +
  theme(axis.line.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA")) +
  facet_grid(.~country_name, scales = "free_x", space = "free_x")

lr <-
  ggplot(mobility_data %>%
           arrange(desc(date)),
         aes(x = from_shutdown, 
             y = doubling_time, 
             color = doubling_time, 
             label = end_label, 
             group = country_name)) + 
  geom_vline(xintercept = 0, linetype = 2) +
  geom_point() +
  #geom_smooth(method = "locfit",  size = 0.5) + #se = FALSE,
  #geom_line(size = 0.5) +
  guides(color = FALSE) + 
  scale_color_gradient(low = "tomato3", high = "yellow2", limits = c(0,27)) +
  ylab("Doubling Time")+
  theme_minimal() +
  theme(axis.line.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA")) +
  facet_grid(.~country_name, scales = "free_x", space = "free_x") +
  ylim(c(0,27))

mobility <-
  ggplot(mobility_data %>%
           arrange(desc(date)),
         aes(x = from_shutdown, 
             y = trend,
             color = doubling_time)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_point() +
  scale_color_gradient(low = "tomato3", high = "yellow2", limits = c(0,27)) +
  labs(x = "Days since lockdown", y = "Residential activity trends") +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.border = element_rect(color = "black", fill = "NA")) +
  facet_grid(.~country_name, scales = "free_x", space = "free_x")

plot_grid(cu,lr,mobility,ncol=1, rel_heights = c(1,1,1.2), align = "v", axis = "b")

ggsave(paste0(covidFigPath, "log_ratio_world.jpg"), height = 8, width = 11)
```

##Provinces

```{r}
can_lockdown <- read.csv(paste0(covidPath,"../canada/can_lockdown.csv"), colClasses = c("character","character","Date"))

#github path
ishaberry_data_url <- "https://raw.githubusercontent.com/ishaberry/Covid19Canada/master/"
# cases.csv: Individual-level cases
#download.file(paste0(ishaberry_data_url,"cases.csv"), 
#              destfile = paste0(covidPath, "cases.csv"), quiet = T)
cases <- read.csv(paste0(covidPath, "cases.csv")) %>%
  mutate(date_report = as.Date(date_report, "%d-%m-%Y")) %>%
  group_by(date_report, province) %>%
  dplyr::summarise(prov_daily_total = n()) %>%
  group_by(province) %>%
  mutate(prov_cu_cases = cumsum(prov_daily_total))

cases

#Google mobility trends
#mobility_data_url <- "https://raw.githubusercontent.com/nacnudus/google-location-coronavirus/master/2020-04-05-country.tsv"
#download.file(mobility_data_url, destfile = paste0(covidPath, "2020-04-05-country.tsv"), quiet = T)

prov <-
  fread(paste0(covidPath, "2020-04-05-country.tsv"), sep = "\t", header = T) %>%
  filter(country_name == "Canada", 
         type == "region",
         category == "Residential") %>%
  dplyr::select(-c(url, page, row,col, group)) %>%
  mutate(date_report = as.Date(date),
         province = gsub("British Columbia","BC", region_name),
         province = gsub("Newfoundland and Labrador","NL", province)) %>%
  inner_join(. ,
             cases,
             by = c("province","date_report")) %>%
  inner_join( . ,
              can_lockdown,
              by = "region_name") %>%
  filter(prov_cu_cases > 10,
         prabb %in% c("QC","ON","AB","BC")) %>%
  arrange(date_report) %>%
  group_by(province) %>%
  mutate(cases_logratio = tsibble::difference(log(prov_cu_cases)),
         doubling_time = log(2) / cases_logratio,
         from_shutdown = as.numeric(difftime(date_report, lockdown_date, units = "days")),
         end_label = ifelse(date == max(date), prabb, NA),
         days_elapsed = as.numeric(date_report - min(date_report)))
  
prov$prabb <- reorder(prov$prabb, -prov$prov_cu_cases)
```

```{r}
p1 <-
  ggplot(prov,
         aes(x = from_shutdown, 
             y = prov_cu_cases, 
             color = prabb, 
             label = end_label, 
             group = prabb)) + 
  geom_vline(xintercept = 0) +
  geom_line(size = 1.5) + 
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") + 
  scale_color_manual(values = cgroup_cols) +
  guides(color = FALSE) + 
  scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                     breaks = 10^seq(1, 10, 1),
                     trans = "log2") + 
  xlab("Days Since Social Distancing Policy") +
  ylab("CODID-19 Cases (log2 scale)")+
  theme_minimal()


p2 <-
 ggplot(prov,
         aes(x = from_shutdown, 
             y = doubling_time, 
             color = prabb, 
             label = end_label, 
             group = prabb))  + 
  geom_vline(xintercept = 0) +
  #geom_point(size = 0.5) + 
  geom_smooth(method = "locfit", se = F) +
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") + 
  scale_color_manual(values = cgroup_cols) +
  guides(color = FALSE) + 
  xlab("Days Since Social Distancing Policy") +
  ylab("Doubling Time")+
  theme_minimal() +
  ylim(c(0,14))

p2.5 <-
 ggplot(prov,
         aes(x = from_shutdown, 
             y = cases_logratio, 
             color = prabb, 
             label = end_label, 
             group = prabb)) + 
  geom_vline(xintercept = 0) +
  #geom_point(size = 0.5) + 
  geom_smooth(method = "locfit", se = F) +
  #geom_line() +
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") + 
  scale_color_manual(values = cgroup_cols) +
  guides(color = FALSE) + 
  xlab("Days Since Social Distancing Policy") +
  ylab("Log Ratio")+
  theme_minimal() +
  ylim(c(0,0.6))

p3 <-
 ggplot(prov,
         aes(x = from_shutdown, 
             y = trend, 
             color = prabb, 
             label = end_label, 
             group = prabb)) + 
  geom_vline(xintercept = 0) +
  #geom_point(size = 0.5) + 
  geom_smooth(method = "locfit", se = F) +
  geom_text_repel(nudge_x = 0.75,
                  segment.color = NA,
                  fontface = "bold") + 
  scale_color_manual(values = cgroup_cols) +
  guides(color = FALSE) + 
  scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                     breaks = 10^seq(1, 10, 1),
                     trans = "log2") + 
  xlab("Days Since Social Distancing Policy") +
  ylab("Residential mobility trends")+
  theme_minimal()
pp <-
plot_grid(p1,p2,p2.5,p3,ncol=1, align = "v", axis = "b")
pp
```

```{r}
cu<-
  ggplot(prov %>%
           arrange(desc(date_report)),
         aes(x = days_elapsed, 
             y = prov_cu_cases, 
             color = doubling_time, 
             label = end_label, 
             group = prabb)) + 
  geom_vline(data = prov %>% filter(from_shutdown == 0),
             aes(xintercept = days_elapsed),
             size = 0.5, linetype =2,
             color = "black") +
  geom_line(size = 1.5) + 
  geom_point(size = 1) + 
  guides(color = FALSE) + 
  scale_color_gradient(low = "tomato3", high = "yellow2") +
  scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                     breaks = 2^seq(-2, 15, 1) * 100,
                     trans = "log2") + 
  ylab("Cumulative Number of Cases (log2 scale)")+
  theme_minimal() +
  theme(axis.line.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA")) +
  facet_grid(.~prabb, scales = "free_x", space = "free_x")

lr <-
ggplot(prov %>%
           arrange(desc(date_report)),
         aes(x = days_elapsed, 
             y = doubling_time, 
             color = doubling_time, 
             label = end_label, 
             group = country_name)) + 
  geom_vline(data = prov %>% filter(from_shutdown == 0),
             aes(xintercept = days_elapsed),
             size = 0.5, linetype =2,
             color = "black") +
  geom_point() +
  geom_smooth(method = "locfit",  size = 0.5, color = "black") + #se = FALSE,
  #geom_line(size = 0.5) +
  guides(color = FALSE) + 
  scale_color_gradient(low = "tomato3", high = "yellow2") +
  ylab("Doubling Time")+
  theme_minimal() +
  theme(axis.line.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA")) +
  facet_grid(.~prabb, scales = "free_x", space = "free_x")

mobility <-
ggplot(prov %>%
           arrange(desc(date_report)),
         aes(x = days_elapsed, 
             y = trend,
             color = doubling_time)) +
  geom_vline(data = prov %>% filter(from_shutdown == 0),
             aes(xintercept = days_elapsed),
             size = 0.5, linetype =2,
             color = "black") +
  geom_point() +
  geom_smooth(method = "locfit",  size = 0.5, color = "black") +
  scale_color_gradient(low = "tomato3", high = "yellow2", breaks = c(2,7,14,21)) +
  labs(x = "Days Since 10th Confirmed Case", y = "Residential activity trends") +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.border = element_rect(color = "black", fill = "NA")) +
  facet_grid(.~prabb, scales = "free_x", space = "free_x")

plot_grid(cu,lr,mobility,ncol=1, rel_heights = c(1,1,1.2), align = "v", axis = "b")

ggsave(paste0(covidFigPath, "log_ratio_canada.jpg"), height = 8, width = 11)
```