---
title: "Covid Log Ratio"
author:
- name: Luke Anderson-Trocm√©,
  affiliation:
  - &cruk Department of Human Genetics, McGill University,  Montreal, Canada
date: '`r format(Sys.Date(), "%Y-%B-%d")`'
output:
  html_notebook:
    df_print: paged
    code_folding: show
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: false
---
# Load libraries and set paths
```{r setup}
pacman::p_load(drat) #to download latest covdata
pacman::p_load(ggplot2) # plotting functions
pacman::p_load(cowplot) # combine plots
pacman::p_load(ggrepel) # repel label text
pacman::p_load(dplyr) # data wrangling
pacman::p_load(broom)
pacman::p_load(jsonlite)
pacman::p_load(data.table)
pacman::p_load(tidyverse)
pacman::p_load(tsibble) # for difference function
pacman::p_load(lubridate)
pacman::p_load(colorspace)
pacman::p_load(ggthemes)
pacman::p_load(locfit)
pacman::p_load(zoo)

#Set Path
covidPath <- '~/Documents/covid19/data/world/'
covidFigPath <- '~/Documents/covid19/figures/'
```
# Load data
```{r, warning = F, message = F}
##################################################
# Coronavirus testing data
# https://ourworldindata.org/coronavirus
##################################################
data_url <- "https://covid.ourworldindata.org/data/owid-covid-data.csv"
# Download data
download.file(data_url, destfile = paste0(covidPath, "owid-covid-data.csv"), quiet = T)

testing <- read.csv(paste0(covidPath,"owid-covid-data.csv")) %>%
  mutate(date = as.Date(date),
         country_region = location)

##################################################
##Government Policy Stringency index
#https://ocgptweb.azurewebsites.net/CSVDownload
##################################################
data_url <- "https://raw.githubusercontent.com/OxCGRT/covid-policy-tracker/master/data/OxCGRT_latest.csv"
# Download data
download.file(data_url, destfile = paste0(covidPath, "OxCGRT_latest.csv"), quiet = T)

# Load and format
OxCGRT <- read.csv(paste0(covidPath, "OxCGRT_latest.csv"))%>%
  mutate(date  = as.Date(as.character(Date),format="%Y%m%d")) %>%
  rename(country_region = CountryName)

##################################################
# Government policy implementation date (Wikipedia)
##################################################
lockdown <- read.csv(paste0(covidPath,"lockdown.csv"), 
                     colClasses = c("character","Date","Date"))

##################################################
# Google mobility trends
# https://www.google.com/covid19/mobility/
##################################################
mobility_data <- 
  fread(paste0(covidPath, "Global_Mobility_Report.csv"), sep = ",", header = T) %>%
  filter(sub_region_1 == "",
         sub_region_2 == "")  %>% 
  mutate(date = as.Date(date))



## Countries to highlight
case_countries <- c("United States","Italy","Canada", "South Korea", "Singapore", "New Zealand", "Japan", "Brazil")

hand_pick <-
  c("United States","Italy","Canada", "South Korea", "Singapore", "New Zealand", "Iceland","Australia","Austria", "Estonia","Slovenia","Greece", "Malaysia", "Switzerland", "Norway", "Denmark","Ireland","Portugal","Czech Republic", "France", "Germany", "Spain", "Netherlands", "Belgium", "Bahrain", "Finland", "Sweden", "United Kingdom", "Japan", "Brazil")
```

#Combine and process data
```{r}
case_limit <- 10


covid <-
  testing %>%
  left_join(. ,
             mobility_data,
             by = c("country_region","date")) %>% 
  left_join( . ,
              OxCGRT,
              by = c("country_region","date")) %>%
  filter(total_cases >= case_limit) %>%
  arrange(date) %>%
  group_by(country_region)%>% 
  mutate(cases_logratio = tsibble::difference(log(total_cases)),
         doubling_time = log(2) / cases_logratio,
         days_elapsed = as.numeric(date - min(date)),
         max_case = max(total_cases, na.rm = T),
         max_tests = max(total_tests_per_thousand, na.rm = T),
         ff = ifelse(country_region %in% case_countries,
                     "bold", "plain"),
         fs = ifelse(country_region %in% case_countries,
                     "1.5", "0.5"),
         fc = ifelse(country_region %in% case_countries,
                     "black", "grey60"))


smooth_out <- data.frame()
for(i in hand_pick) {
  s <- filter(covid, country_region == i)
  
  #s <- filter(covid, country_region == "Canada")
  days <- seq(min(s$days_elapsed), max(s$days_elapsed))
  
  #get smooth
  smooth <-
    ggplot(s, 
           aes(x=days_elapsed, 
               y = doubling_time))+
    geom_smooth(method = "loess")+
    scale_y_continuous(trans = reverselog_trans(2))
  #extract line from plot
  
  extract <-
    ggplot_build(smooth)$data %>%
    as.data.frame() %>%
    mutate(days_elapsed = round(x),
           dt = 2^-y,
           country_region = i) %>%
    dplyr::select(country_region, days_elapsed, dt)
  
  #day_rate <- 
  #  as.data.frame(
  #    sapply(days, 
  #           function(kk) #get moments of doubling
  #             optimize(function(t0) 
  #               abs(approxfun(extract$days_elapsed,extract$dt)(t0) - kk),
  #               interval = range(extract$days_elapsed))$minimum))
  #names(day_rate) <- "smooth"

  
  smooth_out <-
    #day_rate %>%
    #mutate(country_region = paste(i),
    #       days_elapsed = days) %>%
    extract %>%
    rbind(smooth_out, .)
}
smooth_out

smoothed <-
  right_join(smooth_out,
             covid,
             by = c("country_region", "days_elapsed")) %>%
  group_by(country_region) %>%
  fill(dt, .direction = "down")
covid


dc <-
  out %>%
  group_by(country_region, ff) %>%
  mutate(bad_day = ifelse(smooth < 7, 1, 0)) %>%
  dplyr::summarise(tests = max(total_tests_per_thousand, na.rm = T),
                   death = max(total_deaths),
                   sum_bad = sum(bad_day))

subset <- 
  smoothed %>%
  filter(country_region %in% case_countries)

subset$country_region <- fct_reorder(subset$country_region, subset$max_case)
```

#Fancy plotting tid bits 
```{r}

doubled_counts = 2^seq(-2, 15, 1) * 100
double_times <- data.frame()
for (country in unique(subset$country_region)) {
  
  df <-  subset %>% filter(country_region == country)
  
  double_time <- 
    as.data.frame(
      as.Date(sapply(doubled_counts, 
                     function(kk) #get moments of doubling
                       optimize(function(t0) 
                         abs(approxfun(df$date, df$total_cases)(t0) - kk),
                         interval = range(df$date))$minimum), 
              origin = "1970-01-01"))
  names(double_time) <- "doubling_time"
  
  double_times <-
    double_time %>%
    mutate(country_region = paste(country),
           total_cases = doubled_counts,
           lag_total_cases = lag(total_cases),
           lag_doubling_time = lag(doubling_time),
           time = round(doubling_time - lag_doubling_time)) %>%
    distinct(doubling_time, .keep_all = TRUE) %>%
    filter(total_cases <= max(df$total_cases)) %>%
    rbind(double_times, .) 
}

double_times$country_region <- 
  factor(double_times$country_region, levels = levels(subset$country_region))

## rescale doubling time to reverse
#https://stackoverflow.com/questions/11053899/how-to-get-a-reversed-log10-scale-in-ggplot2
library("scales")
reverselog_trans <- function(base = exp(1)) {
  trans <- function(x) -log(x, base)
  inv <- function(x) base^(-x)
  trans_new(paste0("reverselog-", format(base)), trans, inv, 
            log_breaks(base = base), 
            domain = c(1e-100, Inf))
}


n_steps <- 100
alpha_gradient <- seq(from = 0.3, to = 0.001, length.out = n_steps)
y_steps <- seq(from = 0, to = 7, length.out = n_steps + 1)

red_rect <- data.frame(ymin = y_steps[-(n_steps + 1)], 
                            ymax = y_steps[-1],
                            days_elapsed = 0,
                            doubling_time = 0,
                            alpha_gradient = alpha_gradient)

red_rect <- data.frame(ymin = y_steps[-(n_steps + 1)], 
                            ymax = y_steps[-1],
                            days_elapsed = 0,
                            doubling_time = 0,
                            alpha_gradient = alpha_gradient)



 covid %>% filter(country_region == "Japan") %>% dplyr::select(country_region, days_elapsed, doubling_time) 

 out %>% filter(country_region  == "Japan") %>% dplyr::select(country_region, days_elapsed, smooth, doubling_time) %>% filter(smooth <= 7)
```



# Figure 1
```{r}
cu<-
  ggplot(subset,
         aes(x = date, 
             y = total_cases,  
             group = country_region)) + 
  #geom_vline(data = double_times,
  #           aes(xintercept = doubling_time,
  #               group = country_region), linetype = 1, color = "grey80") +
  geom_vline(data = subset %>%
               filter(dt <=7 ), 
             aes(xintercept = date,
                 group = country_region, 
                 alpha = 2^-dt), linetype = 1, color = "tomato", size = 0.65) +
  geom_segment(data = double_times,
               mapping = aes(x = lag_doubling_time,
                             xend = doubling_time,
                             y = total_cases,
                             yend = total_cases),
               color = "black",
               size = 0.5) +
  geom_segment(data = double_times,
               mapping = aes(x = lag_doubling_time,
                             xend = lag_doubling_time,
                             y = lag_total_cases,
                             yend = total_cases),
               color = "black",
               size = 0.5) +
  geom_line(size = 0.5) + 
  geom_line(data = subset,
            aes(y = total_deaths),
            color = "black",
            linetype = 3,
            size = 0.5) +
  geom_line(data = subset,
            aes(y = total_tests),
            color = "black",
            size = 0.5,
            linetype = 2) +
  #scale_alpha_continuous(range = c(0.3,0.01), trans = "log2") +
  guides(alpha = F) +
  scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                     breaks = 2^seq(-3, 15, 1) * 100,
                     trans = "log2",
                     limits = c(10, 10000000)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")+
  ylab("Cumulative Counts\n(log2 scale)")+
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        strip.text = element_text(size = 15,
                                  face = "bold")) +
  facet_grid(.~country_region, scales = "free_x", space = "free_x")


lr <-
  ggplot(subset,
         aes(x = date, 
             y = doubling_time, 
             group = country_region)) + 
  #geom_vline(data = double_times,
  #           aes(xintercept = doubling_time,
  #               group = country_region), linetype = 1, color = "grey80") +
  geom_vline(data = subset %>%
               filter(dt <=7 ), 
             aes(xintercept = date,
                 group = country_region, 
                 alpha = 2^-dt), linetype = 1, color = "tomato", size = 0.65) +
  geom_hline(yintercept = 7, linetype = 2, color = "grey50", size = 0.1) +
  geom_point(size = 0.2) +
  geom_smooth(method = "loess", se = FALSE, color = "black", size = 0.5) +
  #geom_line(data = subset,
  #          aes(x = date,
  #              y = smooth),
  #          size = 0.5) +
  #scale_alpha_continuous(range = c(0.3,0.01), trans = "log2") +
  guides(alpha = F) +
  scale_y_continuous(trans = reverselog_trans(2), 
                     breaks = c(2,4, 7,14,28, 56, 112, 365),
                     labels = c("2 days", "4 days", "1 week", "2 weeks", "1 month", "2 months", "4 months", "1 year")) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")+
  ylab("Doubling Rate\n(log2 scale)")+
  theme_minimal() +
  theme(axis.title.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        strip.text = element_text(size = 15,
                                  face = "bold")) +
  facet_grid(.~country_region, scales = "free_x", space = "free_x")

mob <-
  ggplot(subset,
         aes(x = date, 
             y = residential_percent_change_from_baseline,
             group = country_region)) +
  #geom_vline(data = double_times,
  #           aes(xintercept = doubling_time,
  #               group = country_region), linetype = 1, color = "grey80") +
  geom_vline(data = subset %>%
               filter(dt <=7 ), 
             aes(xintercept = date,
                 group = country_region, 
                 alpha = 2^-dt), linetype = 1, color = "tomato", size = 0.65) +
  geom_point(size = 0.2) +
  geom_smooth(method = "loess", se = FALSE, color = "black", size = 0.5) +
  geom_line(aes(x = date,
                y = StringencyIndex),
            color = "grey50",
            size = 1) +
  #scale_alpha_continuous(range = c(0.3,0.01), trans = "log2") +
  guides(alpha = F) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b")+
  labs(x = "Date", y = "Policy and Mobility Trends (%)") +
  theme_minimal() +
  theme(legend.position = "bottom",
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15),
        strip.text = element_text(size = 15,
                                  face = "bold")) +
  facet_grid(.~country_region, scales = "free_x", space = "free_x")

plot_grid(cu,lr,mob,ncol=1, rel_heights = c(1,1,1.2), align = "v", axis = "b")

ggsave(paste0(covidFigPath, "doubling_time_red_pr.jpg"), height = 15, width = 20)
```


#Figure 2
```{r}
spp<-
  ggplot() + 
  geom_rect(data = red_rect, 
            aes(xmin=0, xmax=max(covid$max_days),
                ymin=ymin, ymax=ymax, 
                alpha=alpha_gradient, group = 1), size = 1, fill="tomato") +
  geom_hline(yintercept = 7, linetype = 2, color = "grey50", size = 0.1) +
  geom_line(data = covid %>%
              filter(!country_region %in% case_countries),
            aes(x = days_elapsed,
                y = smooth,
                size = ff,
                group = country_region),
            color = "grey60") +
  geom_line(data = covid %>%
              filter(country_region %in% case_countries),
            aes(x = days_elapsed,
                y = smooth,
                size = ff,
                group = country_region),
            color = "black") +
  geom_text_repel(data = covid, 
                  aes(x = days_elapsed,
                      y = smooth,
                      size = fs,
                      group = country_region,
                      fontface = ff,
                      label = end_label)) +
  scale_y_continuous(trans = reverselog_trans(2), 
                     breaks = c(2,4, 7,14,28, 56, 112, 224),
                     labels = c("2 days", "4 days", "1 week", "2 weeks", "1 month", "2 months", "4 months", "8 months"),
                     limits = c(max(covid$doubling_time),1)) +
  scale_size_manual(values = c(5,6,1.5,0.7)) +
  scale_color_identity() +
  guides(size = F, alpha = F) +
  labs(x = paste0("Days since ",case_limit,"th reported case"),
       y = "Doubling Rate\n(log2 scale)")+
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))


dcc <-
ggplot(dc %>% filter(country_region %in% hand_pick),
       aes(x = sum_bad,
           y = death,
           label = country_region)) +
  geom_point(alpha = 0.3) +
  geom_point(data = dc %>% 
               filter(tests == -Inf),
             size = 1,
             shape = 2) +
labs(x = "Days of uncontrolled spread",
     y = "Total COVID-19 deaths\n(log2 scale)") +
  scale_size_area(max_size = 14, 
                  breaks = c(10,20,40,80,100),
                  name = "Total tests\nper thousand") +
  scale_y_continuous(trans = "log2",
                     labels = scales::comma_format(accuracy = 1), 
                     breaks = 2^seq(-4, 15, 1) * 100) +
  geom_text_repel(aes(fontface = ff),
                  size = 5) +
  theme_minimal() +
  theme(#legend.position = "bottom",
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 15))


plot_grid(spp, dcc, nrow = 1, align = "h", axis = "l", rel_widths = c(1,1.3))

ggsave(paste0(covidFigPath, paste0("time_since",case_limit,".jpg")), height = 10, width = 22)

```

#positive rate
```{r}
label2 <- 
  covid %>%
  filter(is.na(total_tests) == F,
         is.na(total_cases) == F,
         country_region != "Singapore") %>%
  group_by(country_region) %>%
  top_n( ., 1, wt = days_elapsed) %>%
  mutate(end_label = country_region)
  
    
pr <-
ggplot(subset %>%
         filter(country_region != "Singapore",
                is.na(total_cases / total_tests) == F),
       aes(x = days_elapsed, 
           y = total_cases / total_tests * 1000,  
           group = country_region,
           color = country_region,
           label = end_label)) + 
  geom_smooth(data = covid %>%
                filter(!country_region %in% case_countries,
                       is.na(total_cases / total_tests) == F),
              aes(x = days_elapsed, 
                  y = total_cases / total_tests * 1000,  
                  group = country_region),
              method = "locfit", size = 1.5, se = F,
              color = "grey60") +
  #geom_point(size = 0.5, alpha = 0.5) +
  geom_smooth(mehtod = "locfit",size = 1.5, se = F) + 
  geom_text_repel(data = label2,
                  aes(x = days_elapsed, 
                      y = total_cases / total_tests * 1000,
                      group = country_region,
                      fontface = ff,
                      label = end_label),
                  color = "black") +
  labs(y = "Number of Cases per 1000 Tests",
       x = paste("Days Since",case_limit,"Confirmed Cases"))+
  scale_color_discrete_qualitative()+
  guides(color = F) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))

plot_grid(pr, spp, dcc, nrow = 1, align = "h", axis = "l", rel_widths = c(1,1,1.3))


cu_w <-
  ggplot(subset %>%
           filter(country_region != "Singapore",
                  is.na(total_cases / total_tests) == F),
         aes(x = days_elapsed, 
             y = total_cases,  
             group = country_region,
             color = country_region,
             label = end_label)) + 
  geom_line(size = 1) +
  scale_y_continuous(labels = scales::comma_format(accuracy = 1), 
                     breaks = 2^seq(-2, 15, 1) * 100,
                     trans = "log2",
                     limits = c(50, 1000000)) +
  geom_text_repel(data = label2 %>%
                    filter(country_region %in% case_countries),
                  aes(x = days_elapsed, 
                      y = total_cases,
                      group = country_region,
                      fontface = ff,
                      label = end_label),
                  color = "black") +
  labs(y = "Cumulative Number of Confirmed Cases",
       x = paste("Days Since",case_limit,"Confirmed Cases"))+
  scale_color_discrete_qualitative()+
  guides(color = F) +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA"),
        axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 15),
        axis.title = element_text(size = 15))

pr_w <-
  ggplot(subset %>%
           filter(country_region != "Singapore",
                  country_region %in% case_countries,
                  is.na(total_cases / total_tests) == F),
         aes(x = days_elapsed, 
             y = total_cases / total_tests * 1000,  
             group = country_region,
             color = country_region,
             label = end_label)) + 
  geom_point(size = 0.5, alpha = 0.5) +
  geom_smooth(method = "locfit",size = 1, se = F) + 
  geom_text_repel(data = label2%>%
                    filter(country_region %in% case_countries),
                  aes(x = days_elapsed, 
                      y = total_cases / total_tests * 1000,
                      group = country_region,
                      fontface = ff,
                      label = end_label),
                  color = "black") +
  labs(y = "Number of Cases per 1000 Tests",
       x = paste("Days Since",case_limit,"Confirmed Cases"))+
  scale_color_discrete_qualitative()+
  guides(color = F) +
  theme_minimal() +
  theme(panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.border = element_rect(color = "black", fill = "NA"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15))


plot_grid(cu_w, pr_w, ncol =1, align = "v", axis = "b")

```

