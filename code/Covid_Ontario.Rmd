---
title: "Covid in Ontario"
author:
- name: Luke Anderson-Trocm√©,
  affiliation:
  - &cruk Department of Human Genetics, McGill University,  Montreal, Canada
date: '`r format(Sys.Date(), "%Y-%B-%d")`'
output:
  html_notebook:
    df_print: paged
    code_folding: show
    toc: yes
    toc_float:
      collapsed: false
      smooth_scroll: false
---
# Load Libraries and set paths
```{r setup}
library(ggplot2)   # plotting functions
library(ggrepel)   # repel label text
library(cowplot)   # combine plots
library(dplyr)     # data wrangling
library(tidyverse) # data wrangling

#Set Path
covidPath <- '~/Documents/covid19/data/ontario/'
covidFigPath <- '~/Documents/covid19/figures/'

today <- format(Sys.Date(), "%B-%d-%Y")
```
# Load Data
```{r, warning = F, message = F}
# Corona virus data is downloaded from : 
data_url <- "https://data.ontario.ca/dataset/f4112442-bdc8-45d2-be3c-12efae72fb27/resource/455fd63b-603d-4608-8216-7d8647f43350/download/conposcovidloc.csv"

# Download data
download.file(data_url, destfile = paste0(covidPath, "conposcovidloc.csv"), quiet = T)


#Location Maps
#get Canadian borders
canada <- raster::getData(name = "GADM",
                          country = "CAN",
                          level = 1)
#get Quebec borders
ON <- canada[canada$NAME_1 %in% "Ontario",]

# Load data
covid_on <- 
  read.csv(paste0(covidPath, "conposcovidloc.csv")) %>%
  mutate(ACCURATE_EPISODE_DATE = as.Date(ACCURATE_EPISODE_DATE))

#get time range for plotting
start_on <- min(covid_on$ACCURATE_EPISODE_DATE)
end_on <- max(covid_on$ACCURATE_EPISODE_DATE)
#header of the data
covid_on

#group by city
loc_covid_on <-
  covid_on %>%
  group_by(Reporting_PHU_Latitude, Reporting_PHU_Longitude,Reporting_PHU_City) %>%
  dplyr::summarise(count = n()) %>%
  arrange(-count, Reporting_PHU_City)
```
#Make Plots
## Map of Cases in Ontario
```{r, message = F}
#new map limits
Lat1 <- min(covid_on$Reporting_PHU_Latitude, na.rm = T) - 0.8
Lat2 <- max(covid_on$Reporting_PHU_Latitude, na.rm = T) + 0.2
Lon1 <- min(covid_on$Reporting_PHU_Longitude, na.rm = T) - 0.2
Lon2 <- max(covid_on$Reporting_PHU_Longitude, na.rm = T) + 0.2
#crop
new.ext.on <- raster::extent(c(Lon1,Lon2,Lat1,Lat2))
ON <- raster::crop(ON, new.ext.on)

set.seed(101)

ontario_map <-
  ggplot(ON,aes(x=long,y=lat)) +
  geom_path(aes(group = group),
            color = 'grey70') +
  coord_map() +
  geom_point(data = loc_covid_on,
             aes(x=Reporting_PHU_Longitude,
                 y=Reporting_PHU_Latitude ,
                 size = count),
             color = "red",
             alpha = 0.3) +
  geom_point(data = loc_covid_on %>%
               arrange(count),
             aes(x=Reporting_PHU_Longitude,
                 y=Reporting_PHU_Latitude,
                 size = count),
             color = "red",
             shape = 1) +
  geom_text_repel(data = loc_covid_on,
                  aes(x=Reporting_PHU_Longitude,
                      y=Reporting_PHU_Latitude,
                      label = Reporting_PHU_City),
                  size = 2,
                  segment.size = 0) +
  scale_size_area(breaks = c(10,100,400),
                  max_size = 15,
                  name = "Count") +
  scale_color_distiller(palette = "RdYlGn",
                        direction = -1,
                        trans = "log10",
                        guide = FALSE) +
  labs(title = paste0("Cases per city")) +
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.line = element_blank(),
        plot.title = element_text(hjust = 0.5, size = 20))

ontario_map

ggsave(paste0(covidFigPath,"Ontario_Covid_",today,"_map.jpg"), height = 10, width = 15)
```
## Cases by city
```{r, warning=F}
covid_on_city <-
  covid_on %>%
  group_by(Reporting_PHU_City) %>%
  dplyr::summarise(city_total = n()) %>%
  left_join( . , covid_on, by = "Reporting_PHU_City")

covid_on_city <-
  covid_on_city %>%
  group_by(ACCURATE_EPISODE_DATE, Reporting_PHU_City) %>%
  dplyr::summarise(city_total_day = n()) %>%
  group_by(Reporting_PHU_City) %>%
  mutate(city_total_cumulative = cumsum(city_total_day)) %>%
  left_join( . , covid_on_city, by = c("ACCURATE_EPISODE_DATE","Reporting_PHU_City")) %>%
  arrange(Reporting_PHU_City, ACCURATE_EPISODE_DATE)

covid_on_labels <-
  covid_on_city %>%
  dplyr::select(ACCURATE_EPISODE_DATE, Reporting_PHU_City, city_total) %>%
  unique() %>%
  group_by(Reporting_PHU_City) %>%
  top_n(x = . , n = 1, wt = ACCURATE_EPISODE_DATE) %>%
  ungroup() %>%
  top_n(x = ., n = 10, wt = city_total)

covid_on_total <-
  covid_on %>%
  group_by(ACCURATE_EPISODE_DATE) %>%
  dplyr::summarise(ontario_total_day = n()) %>%
  mutate(ontario_total = cumsum(ontario_total_day))


city_rate <-
  covid_on_city %>%
  dplyr::select(ACCURATE_EPISODE_DATE, Reporting_PHU_City, city_total_cumulative) %>%
  arrange(ACCURATE_EPISODE_DATE) %>%
  group_by(Reporting_PHU_City) %>%
  mutate(time_diff = ACCURATE_EPISODE_DATE - lag(ACCURATE_EPISODE_DATE),  # just in case there are gaps in data
         case_diff = city_total_cumulative - lag(city_total_cumulative), # count diff in cases between dates
         rate_percent = (case_diff / as.numeric(time_diff)) / lag(city_total_cumulative) * 100) %>%# growth rate
  group_by(Reporting_PHU_City) %>%
  filter(rate_percent < Inf, # remove infinity from mean rate
         city_total_cumulative >= 10) %>% #min cases
  dplyr::summarise(double_time = log(2) / mean(rate_percent, na.rm = TRUE)) %>%
  left_join( . , covid_on_city, by = "Reporting_PHU_City")


city_path <-
  ggplot()+
  geom_path(data = city_rate,
            aes(x = ACCURATE_EPISODE_DATE,
                y = city_total_cumulative,
                color = double_time,
                group = Reporting_PHU_City),
            size = 1.5) +
  geom_path(data = covid_on_total%>%
              filter(ontario_total >= 10),
            aes(x = ACCURATE_EPISODE_DATE, 
                y = ontario_total, 
                group = 1),
            color = "black",
            linetype = 2) +
  geom_text_repel(data = covid_on_labels,
                  aes(x = ACCURATE_EPISODE_DATE, 
                      y = city_total,
                      label = Reporting_PHU_City),
                  color = "black",
                  segment.alpha = 0.2,
                  direction = "y",
                  nudge_x = end_on + 5,
                  hjust = 1) +
  scale_y_log10() + 
  xlim(c(start_on, end_on + 10)) +
  annotation_logticks(sides = "l") +
scale_color_distiller(palette = "RdYlGn",
                      direction = -1,
                      name = "Total cases") +
  theme_bw() +
  labs(x = "Date",
       y = "Total number of cases") +
  ggtitle("Cases over time") +
  theme(plot.title = element_text(hjust = 0.5, size = 20),
        panel.grid.minor = element_blank(),
        axis.title = element_text(size = 15))

city_path

ggsave(paste0(covidFigPath,"Ontario_Covid_",today,".jpg"), height = 5, width = 8)
```

## Age distribution of Covid-19 cases
```{r}
age_group <-
  ggplot(covid_on%>%
           filter(Age_Group != "Unknown"),
         aes(x = ACCURATE_EPISODE_DATE,
             fill = Age_Group)) +
  geom_histogram(binwidth = 1) +
  scale_fill_brewer(palette = "RdYlGn",
                    type = "seq",
                    direction = -1,
                    name = "Age Group") +
  labs(x = "Date",
       y = "Total number of cases",
       title = paste0("Age distribution of cases")) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 20),
        panel.grid.minor = element_blank())

age_group

ggsave(paste0(covidFigPath,"Ontario_Covid_",today,"_age_bin.jpg"), height = 7, width = 10)
```

##Case information of COVID-19
```{r}
case_info<-
  ggplot(covid_on,
         aes(x = ACCURATE_EPISODE_DATE,
             fill = CASE_ACQUISITIONINFO)) +
  geom_histogram(binwidth = 1) +
  scale_fill_brewer(name = "Case Info") +
  labs(x = "Date",
       y = "Total number of cases",
       title = paste0("Case information")) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 20),
        panel.grid.minor = element_blank())

case_info

ggsave(paste0(covidFigPath,"Ontario_Covid_",today,"_case_info.jpg"), height = 7, width = 10)
```
##Age distribution of COVID-19 outcomes 
```{r}
outcomes <-
  ggplot(covid_on %>%
           filter(Age_Group != "Unknown"),
         aes(x = Age_Group,
             color = RESOLVED,
             group = RESOLVED)) +
  geom_freqpoly(stat = "count",
                size = 2) +
  scale_color_brewer(palette = 8, direction = -1) +
  labs(x = "Age Group",
       y = "Total number of cases",
       title = paste0("Age distribution of outcomes")) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 20),
        panel.grid.minor.x = element_blank())

outcomes

ggsave(paste0(covidFigPath,"Ontario_Covid_",today,"_outcome.jpg"), height = 7, width = 10)
```

```{r, fig.height=10}

title <- ggdraw() + 
  draw_label(
    paste0("Covid Cases in Ontario (",today,")"),
    fontface = 'bold',
    hjust = 0.5,
    size = 25)

combined_plots <-
  plot_grid(title,
    plot_grid(ontario_map, 
              city_path,
              nrow = 1,
              align = "h",
              axis = "l"),
    plot_grid(age_group,
              case_info,
              outcomes,
              nrow = 1,
              align = "h",
              axis = "b"),
    nrow = 3,
    rel_heights = c(0.2, 1, 0.6))

combined_plots

ggsave(paste0(covidFigPath,"Ontario_Covid_",today,"_summary.jpg"), height = 10, width = 20)
```